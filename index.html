<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cotizador Simple - Ecomoving</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; color: #111827; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    header { background: #3b82f6; color: white; padding: 20px; text-align: center; }
    .logo { height: 50px; margin-right: 10px; }
    h1 { margin: 0; display: inline; }
    form { padding: 20px; }
    h2 { color: #374151; margin-bottom: 10px; }
    input, select { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { background: #f3f4f6; font-weight: 600; }
    .subtotal-col { text-align: right; font-weight: bold; }
    button { background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #2563eb; }
    .add-btn { background: #10b981; }
    .add-btn:hover { background: #059669; }
    .delete-btn { background: #ef4444; font-size: 16px; }
    .delete-btn:hover { background: #dc2626; }
    .totals { margin-top: 20px; text-align: right; }
    .total { font-size: 1.5em; font-weight: bold; color: #1f2937; }
    .actions { text-align: center; margin: 20px 0; }
    .actions button { margin: 0 5px; padding: 10px 20px; font-size: 16px; }
    #preview { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    #preview-content { background: white; margin: 50px auto; padding: 20px; max-width: 600px; border-radius: 8px; }
    .close { float: right; cursor: pointer; font-size: 24px; }
    @media (max-width: 600px) { body { padding: 10px; } .container { border-radius: 0; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://via.placeholder.com/150x50/3b82f6/ffffff?text=Ecomoving" alt="Logo" class="logo">
      <h1>Cotizador</h1>
    </header>
    <form id="cotizadorForm">
      <h2>Datos del Cliente</h2>
      <input type="text" id="cliente" placeholder="Nombre del cliente" required>

      <h2>Productos / Servicios</h2>
      <table id="tabla">
        <thead>
          <tr>
            <th>Descripci√≥n</th>
            <th>Cantidad</th>
            <th>Precio Unit.</th>
            <th>Descuento (%)</th>
            <th class="subtotal-col">Subtotal</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button type="button" class="add-btn" onclick="agregarFila()">+ A√±adir √≠tem</button>

      <div class="totals">
        <div>Subtotal: $<span id="subtotal">0</span></div>
        <div>Descuento total: $<span id="descTotal">0</span></div>
        <div>IVA (19%): $<span id="iva">0</span></div>
        <div class="total">Total: $<span id="total">0</span></div>
      </div>

      <div class="actions">
        <button type="button" onclick="generarCotizacion()">Generar Cotizaci√≥n</button>
      </div>
    </form>
  </div>

  <!-- Modal Preview -->
  <div id="preview">
    <div id="preview-content">
      <span class="close" onclick="cerrarPreview()">&times;</span>
      <div id="cotizacionPreview"></div>
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="copiarCotizacion()">Copiar</button>
        <button onclick="descargarPDF()">Descargar PDF</button>
        <button onclick="descargarImagen()">Descargar Imagen</button>
      </div>
    </div>
  </div>

  <script>
    const tbody = document.querySelector('#tabla tbody');
    let ivaRate = 0.19;

    function agregarFila() {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td><input type="text" class="desc" oninput="calcular()"></td>
        <td><input type="number" class="cant" value="1" min="1" oninput="calcular()"></td>
        <td><input type="number" class="precio" step="0.01" min="0" oninput="calcular()"></td>
        <td><input type="number" class="descuento" value="0" min="0" max="100" oninput="calcular()"></td>
        <td class="subtotal-col"><span class="sub">0</span></td>
        <td><button type="button" class="delete-btn" onclick="eliminarFila(this)">üóëÔ∏è</button></td>
      `;
    }

    function eliminarFila(btn) {
      btn.closest('tr').remove();
      calcular();
    }

    function calcular() {
      let subtotal = 0;
      let descTotal = 0;
      tbody.querySelectorAll('tr').forEach(row => {
        const descInput = row.querySelector('.desc');
        const cant = parseFloat(row.querySelector('.cant').value) || 0;
        const precio = parseFloat(row.querySelector('.precio').value) || 0;
        const descuento = parseFloat(row.querySelector('.descuento').value) || 0;
        const subLinea = cant * precio * (1 - descuento / 100);
        row.querySelector('.sub').textContent = subLinea.toFixed(2);
        subtotal += subLinea;
        descTotal += cant * precio * (descuento / 100);
      });
      const iva = subtotal * ivaRate;
      const total = subtotal + iva;
      document.getElementById('subtotal').textContent = subtotal.toFixed(2);
      document.getElementById('descTotal').textContent = descTotal.toFixed(2);
      document.getElementById('iva').textContent = iva.toFixed(2);
      document.getElementById('total').textContent = total.toFixed(2);
    }

    function generarCotizacion() {
      const cliente = document.getElementById('cliente').value || 'Cliente';
      let itemsHtml = '';
      let subtotal = 0;
      tbody.querySelectorAll('tr').forEach(row => {
        const desc = row.querySelector('.desc').value;
        const cant = row.querySelector('.cant').value;
        const precio = row.querySelector('.precio').value;
        const descuento = row.querySelector('.descuento').value;
        const sub = parseFloat(row.querySelector('.sub').textContent);
        if (desc) {
          itemsHtml += `<tr><td>${desc}</td><td>${cant}</td><td>$${precio}</td><td>${descuento}%</td><td>$${sub.toFixed(2)}</td></tr>`;
          subtotal += sub;
        }
      });
      const iva = parseFloat(document.getElementById('iva').textContent);
      const total = parseFloat(document.getElementById('total').textContent);
      const fecha = new Date().toLocaleDateString('es-CL');
      const preview = `
        <div style="text-align: center;">
          <h2>Cotizaci√≥n</h2>
          <p><strong>Cliente:</strong> ${cliente}</p>
          <p><strong>Fecha:</strong> ${fecha}</p>
        </div>
        <table style="width:100%; border-collapse:collapse; margin:10px 0;">
          <thead><tr style="background:#f3f4f6;"><th>Descripci√≥n</th><th>Cant.</th><th>P. Unit.</th><th>Desc.</th><th>Subtotal</th></tr></thead>
          <tbody>${itemsHtml}</tbody>
        </table>
        <div style="text-align:right;">
          <p>Subtotal: $${subtotal.toFixed(2)}</p>
          <p>IVA 19%: $${iva.toFixed(2)}</p>
          <p><strong>Total: $${total.toFixed(2)}</strong></p>
        </div>
        <p style="font-size:0.8em; margin-top:20px;">V√°lido por 30 d√≠as. Gracias por su preferencia.</p>
      `;
      document.getElementById('cotizacionPreview').innerHTML = preview;
      document.getElementById('preview').style.display = 'block';
    }

    function cerrarPreview() {
      document.getElementById('preview').style.display = 'none';
    }

    function copiarCotizacion() {
      const content = document.getElementById('cotizacionPreview').innerText;
      navigator.clipboard.writeText(content).then(() => alert('Copiado al portapapeles'));
    }

    function descargarPDF() {
      const element = document.getElementById('cotizacionPreview');
      html2pdf().from(element).save('cotizacion.pdf');
      cerrarPreview();
    }

    function descargarImagen() {
      // Usando html2canvas para imagen (simula la exportaci√≥n de la original)
      html2canvas(document.getElementById('cotizacionPreview')).then(canvas => {
        const link = document.createElement('a');
        link.download = 'cotizacion.png';
        link.href = canvas.toDataURL();
        link.click();
      });
      cerrarPreview();
    }

    // Inicializar
    agregarFila();
    window.onclick = (e) => { if (e.target.id === 'preview') cerrarPreview(); };
  </script>
</body>
</html>